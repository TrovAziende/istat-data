name: Update ISTAT Regioni

on:
  schedule:
    - cron: "0 3 1 */3 *"
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests lxml

      - name: Create Python script
        run: |
          cat << 'PYTHON' > script.py
          import requests
          from lxml import etree
          import json
          from datetime import datetime

          # =========================
          # CONFIG REGIONI
          # =========================

          regioni = {
              "ITC1": {"istat":"01","nome":"Piemonte","slug":"piemonte","superficie":25387},
              "ITC2": {"istat":"02","nome":"Valle d'Aosta","slug":"valle-daosta","superficie":3263},
              "ITC3": {"istat":"07","nome":"Liguria","slug":"liguria","superficie":5416},
              "ITC4": {"istat":"03","nome":"Lombardia","slug":"lombardia","superficie":23863},
              "ITD1": {"istat":"05","nome":"Veneto","slug":"veneto","superficie":18345},
              "ITD2": {"istat":"06","nome":"Friuli-Venezia Giulia","slug":"friuli-venezia-giulia","superficie":7924},
              "ITD3": {"istat":"08","nome":"Emilia-Romagna","slug":"emilia-romagna","superficie":22453},
              "ITD4": {"istat":"09","nome":"Toscana","slug":"toscana","superficie":22987},
              "ITD5": {"istat":"10","nome":"Umbria","slug":"umbria","superficie":8456},
              "ITDA": {"istat":"11","nome":"Marche","slug":"marche","superficie":9366},
              "ITE1": {"istat":"12","nome":"Lazio","slug":"lazio","superficie":17232},
              "ITE2": {"istat":"13","nome":"Abruzzo","slug":"abruzzo","superficie":10831},
              "ITE3": {"istat":"14","nome":"Molise","slug":"molise","superficie":4460},
              "ITE4": {"istat":"15","nome":"Campania","slug":"campania","superficie":13671},
              "ITF1": {"istat":"16","nome":"Puglia","slug":"puglia","superficie":19359},
              "ITF2": {"istat":"17","nome":"Basilicata","slug":"basilicata","superficie":9992},
              "ITF3": {"istat":"18","nome":"Calabria","slug":"calabria","superficie":15080},
              "ITF4": {"istat":"19","nome":"Sicilia","slug":"sicilia","superficie":25711},
              "ITF5": {"istat":"20","nome":"Sardegna","slug":"sardegna","superficie":24100}
          }

          # Trentino-Alto Adige (gestione separata)
          trentino = {
              "istat":"04",
              "nome":"Trentino-Alto Adige",
              "slug":"trentino-alto-adige",
              "superficie":13607
          }

          # =========================
          # ANNI DINAMICI
          # =========================

          current_year = datetime.now().year
          start_year = current_year - 5

          # =========================
          # QUERY MULTIPLA
          # =========================

          nuts_list = "+".join(regioni.keys())

          url = (
              "https://esploradati.istat.it/SDMXWS/rest/data/"
              "IT1,22_289_DF_DCIS_POPRES1_1,1.0/"
              f"A.{nuts_list}.JAN.9..99/ALL/"
              "?detail=dataonly"
              f"&startPeriod={start_year}-01-01"
              f"&endPeriod={current_year}-12-31"
              "&dimensionAtObservation=TIME_PERIOD"
          )

          response = requests.get(url, timeout=120)
          response.raise_for_status()

          root = etree.fromstring(response.content)

          ns = {
              "g": "http://www.sdmx.org/resources/sdmxml/schemas/v2_1/data/generic"
          }

          dataset = {}

          series_nodes = root.xpath("//g:Series", namespaces=ns)

          for series in series_nodes:

              ref_area = series.xpath("./g:SeriesKey/g:Value[@id='REF_AREA']/@value", namespaces=ns)
              age = series.xpath("./g:SeriesKey/g:Value[@id='AGE']/@value", namespaces=ns)

              if not ref_area or not age:
                  continue

              if age[0] != "TOTAL":
                  continue

              nuts = ref_area[0]

              if nuts not in regioni:
                  continue

              info = regioni[nuts]
              istat = info["istat"]

              observations = series.xpath("./g:Obs", namespaces=ns)

              serie = {}
              for obs in observations:
                  anno = obs.xpath("./g:ObsDimension/@value", namespaces=ns)[0]
                  val  = int(obs.xpath("./g:ObsValue/@value", namespaces=ns)[0])
                  serie[anno] = val

              serie = dict(sorted(serie.items()))

              dataset[istat] = {
                  "nome": info["nome"],
                  "slug": info["slug"],
                  "superficie_km2": info["superficie"],
                  "popolazione": list(serie.values())[-1] if serie else None,
                  "serie_popolazione": serie
              }

          # =========================
          # TRATTAMENTO TRENTINO (somma Bolzano + Trento)
          # =========================

          def get_prov(nuts_code):
              prov_url = (
                  "https://esploradati.istat.it/SDMXWS/rest/data/"
                  "IT1,22_289_DF_DCIS_POPRES1_1,1.0/"
                  f"A.{nuts_code}.JAN.9..99/ALL/"
                  "?detail=dataonly"
                  f"&startPeriod={start_year}-01-01"
                  f"&endPeriod={current_year}-12-31"
                  "&dimensionAtObservation=TIME_PERIOD"
              )
              r = requests.get(prov_url, timeout=120)
              if r.status_code != 200:
                  return None

              root_p = etree.fromstring(r.content)
              series_nodes_p = root_p.xpath("//g:Series", namespaces=ns)

              for series in series_nodes_p:
                  age = series.xpath("./g:SeriesKey/g:Value[@id='AGE']/@value", namespaces=ns)
                  if not age or age[0] != "TOTAL":
                      continue

                  observations = series.xpath("./g:Obs", namespaces=ns)
                  serie = {}
                  for obs in observations:
                      anno = obs.xpath("./g:ObsDimension/@value", namespaces=ns)[0]
                      val  = int(obs.xpath("./g:ObsValue/@value", namespaces=ns)[0])
                      serie[anno] = val
                  return dict(sorted(serie.items()))
              return None

          bolzano = get_prov("ITH10")
          trento  = get_prov("ITH20")

          if bolzano and trento:
              serie = {}
              for anno in bolzano:
                  serie[anno] = bolzano[anno] + trento[anno]

              dataset["04"] = {
                  "nome": trentino["nome"],
                  "slug": trentino["slug"],
                  "superficie_km2": trentino["superficie"],
                  "popolazione": list(serie.values())[-1],
                  "serie_popolazione": serie
              }

          dataset = dict(sorted(dataset.items()))

          with open("regioni.json", "w", encoding="utf-8") as f:
              json.dump(dataset, f, ensure_ascii=False, indent=2)

          print("regioni.json aggiornato dinamicamente")
          PYTHON

      - name: Run script
        run: python script.py

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add regioni.json
          git diff --quiet && git diff --staged --quiet || git commit -m "Aggiornamento automatico regioni.json"
          git push

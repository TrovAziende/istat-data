import requests
import json

# =========================
# CONFIG REGIONI
# =========================

regioni = {
    "ITC1": ("01", "Piemonte"),
    "ITC2": ("02", "Valle d'Aosta"),
    "ITC4": ("03", "Lombardia"),
    "ITDA": ("04", "Trentino-Alto Adige"),
    "ITD3": ("05", "Veneto"),
    "ITD4": ("06", "Friuli-Venezia Giulia"),
    "ITC3": ("07", "Liguria"),
    "ITD5": ("08", "Emilia-Romagna"),
    "ITE1": ("09", "Toscana"),
    "ITE2": ("10", "Umbria"),
    "ITE3": ("11", "Marche"),
    "ITE4": ("12", "Lazio"),
    "ITF1": ("13", "Abruzzo"),
    "ITF2": ("14", "Molise"),
    "ITF3": ("15", "Campania"),
    "ITF4": ("16", "Puglia"),
    "ITF5": ("17", "Basilicata"),
    "ITF6": ("18", "Calabria"),
    "ITG1": ("19", "Sicilia"),
    "ITG2": ("20", "Sardegna"),
}

# =========================
# DOWNLOAD
# =========================

url = "https://opendata.marche.camcom.it/data/Stock-Imprese-Attive-Italia.json"

print("Download dataset imprese attive...")
r = requests.get(url, timeout=60)
r.raise_for_status()
data = r.json()

dimension = data["dimension"]
dim_ids = dimension["id"]        # ordine reale dimensioni
dim_sizes = dimension["size"]    # dimensioni

values = data["value"]

# Recupero nomi reali dimensioni
geo_dim = dim_ids[0]
settore_dim = dim_ids[1]
tempo_dim = dim_ids[2]

geo_keys = list(dimension[geo_dim]["category"]["index"].keys())
settore_keys = list(dimension[settore_dim]["category"]["index"].keys())
tempo_keys = list(dimension[tempo_dim]["category"]["index"].keys())

# ultimo mese disponibile
ultimo_tempo = tempo_keys[-1]
tempo_index = tempo_keys.index(ultimo_tempo)

# settore totale (primo indice)
settore_index = 0

# funzione robusta calcolo posizione JSON-stat
def get_value(geo_key):
    geo_index = geo_keys.index(geo_key)

    # formula ufficiale JSON-stat (row-major order)
    pos = (
        geo_index * dim_sizes[1] * dim_sizes[2]
        + settore_index * dim_sizes[2]
        + tempo_index
    )

    return values[pos]

# totale Italia
totale_italia = get_value("IT")

dataset = {}

for nuts, (codice, nome) in regioni.items():
    valore = get_value(nuts)

    dataset[codice] = {
        "nome": nome,
        "anno_ultimo": ultimo_tempo,
        "imprese_attive": int(valore),
    }

# quote %
for codice in dataset:
    quota = (dataset[codice]["imprese_attive"] / totale_italia) * 100
    dataset[codice]["quota_percentuale_nazionale"] = round(quota, 2)

# ranking
ordinato = sorted(
    dataset.items(),
    key=lambda x: x[1]["imprese_attive"],
    reverse=True
)

for rank, (codice, _) in enumerate(ordinato, start=1):
    dataset[codice]["rank_imprese"] = rank

dataset = dict(sorted(dataset.items()))

with open("imprese.json", "w", encoding="utf-8") as f:
    json.dump(dataset, f, ensure_ascii=False, indent=2)

print("imprese.json aggiornato correttamente")

name: Update Imprese Attive Regioni

on:
  schedule:
    - cron: "0 4 1 * *"
  workflow_dispatch:

jobs:
  update-imprese:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Create Python script
        run: |
          cat << 'PYTHON' > script_imprese.py
          import requests
          import json

          # =========================
          # CONFIG REGIONI (codici NUTS2)
          # =========================

          regioni = {
              "ITC1": ("01", "Piemonte"),
              "ITC2": ("02", "Valle d'Aosta"),
              "ITC4": ("03", "Lombardia"),
              "ITH1_H2": ("04", "Trentino-Alto Adige"),
              "ITH3": ("05", "Veneto"),
              "ITH4": ("06", "Friuli-Venezia Giulia"),
              "ITC3": ("07", "Liguria"),
              "ITH5": ("08", "Emilia-Romagna"),
              "ITI1": ("09", "Toscana"),
              "ITI2": ("10", "Umbria"),
              "ITI3": ("11", "Marche"),
              "ITI4": ("12", "Lazio"),
              "ITF1": ("13", "Abruzzo"),
              "ITF2": ("14", "Molise"),
              "ITF3": ("15", "Campania"),
              "ITF4": ("16", "Puglia"),
              "ITF5": ("17", "Basilicata"),
              "ITF6": ("18", "Calabria"),
              "ITG1": ("19", "Sicilia"),
              "ITG2": ("20", "Sardegna"),
          }

          url = "https://opendata.marche.camcom.it/data/Stock-Imprese-Attive-Italia.json"

          print("Download dataset imprese attive...")
          r = requests.get(url, timeout=60)
          r.raise_for_status()
          data = r.json()

          dimension = data["dimension"]
          values = data["value"]

          metric_keys = dimension["metric"]["category"]["index"]
          geo_keys = dimension["geo"]["category"]["index"]
          ateco_keys = dimension["ateco2025"]["category"]["index"]
          time_keys = dimension["time"]["category"]["index"]

          size_metric = len(metric_keys)
          size_geo = len(geo_keys)
          size_ateco = len(ateco_keys)
          size_time = len(time_keys)

          metric_index = 0  # unico indicatore
          ateco_index = ateco_keys.index("TOTAL")
          time_index = size_time - 1  # ultimo mese

          ultimo_label = dimension["time"]["category"]["label"][time_keys[time_index]]

          def get_value(geo_code):
              geo_index = geo_keys.index(geo_code)

              pos = (
                  metric_index * (size_geo * size_ateco * size_time)
                  + geo_index * (size_ateco * size_time)
                  + ateco_index * size_time
                  + time_index
              )

              return values[pos]

          totale_italia = get_value("IT")

          dataset = {}

          for nuts, (codice, nome) in regioni.items():
              valore = get_value(nuts)

              dataset[codice] = {
                  "nome": nome,
                  "anno_ultimo": ultimo_label,
                  "imprese_attive": int(valore),
              }

          # quota %
          for codice in dataset:
              quota = (dataset[codice]["imprese_attive"] / totale_italia) * 100
              dataset[codice]["quota_percentuale_nazionale"] = round(quota, 2)

          # ranking
          ordinato = sorted(
              dataset.items(),
              key=lambda x: x[1]["imprese_attive"],
              reverse=True
          )

          for rank, (codice, _) in enumerate(ordinato, start=1):
              dataset[codice]["rank_imprese"] = rank

          dataset = dict(sorted(dataset.items()))

          with open("imprese.json", "w", encoding="utf-8") as f:
              json.dump(dataset, f, ensure_ascii=False, indent=2)

          print("imprese.json aggiornato correttamente")
          PYTHON

      - name: Run script
        run: python script_imprese.py

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add imprese.json
          git diff --quiet && git diff --staged --quiet || git commit -m "Aggiornamento automatico imprese.json"
          git push
